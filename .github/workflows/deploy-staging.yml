name: Deploy to Staging

on:
  push:
    branches:
      - main

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-dependencies

      - name: Run unit tests
        run: npm test -- --coverage --watchAll=false --passWithNoTests

  lint:
    name: Check Formatting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-dependencies

      - name: Run linters
        uses: wearerequired/lint-action@v2
        with:
          eslint: true
          prettier: true

  deploy:
    needs: [test, lint]
    name: Deploy Frontend to Heroku Staging
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Heroku
        uses: ./.github/actions/deploy-to-heroku
        with:
          heroku-api-key: ${{ secrets.HEROKU_API_KEY }}
          heroku-app-name: ${{ secrets.HEROKU_STAGING_APP_NAME }}
          heroku-email: ${{ secrets.HEROKU_EMAIL }}

      - name: Get commit info
        id: commit_info
        run: |
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=%B | head -n 1)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT

      - name: Send success notification to Slack
        if: success()
        uses: ./.github/actions/slack-notify
        with:
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          status: success
          environment: staging
          commit-sha: ${{ steps.commit_info.outputs.sha }}
          commit-message: ${{ steps.commit_info.outputs.message }}
          commit-author: ${{ steps.commit_info.outputs.author }}

      - name: Send failure notification to Slack
        if: failure()
        uses: ./.github/actions/slack-notify
        with:
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          status: failure
          environment: staging
          commit-sha: ${{ steps.commit_info.outputs.sha }}
          commit-message: ${{ steps.commit_info.outputs.message }}
          commit-author: ${{ steps.commit_info.outputs.author }}
