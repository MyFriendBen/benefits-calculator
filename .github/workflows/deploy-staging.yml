name: Deploy to Staging

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Frontend to Heroku Staging
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Heroku
        uses: ./.github/actions/deploy-to-heroku
        with:
          heroku-api-key: ${{ secrets.HEROKU_API_KEY }}
          heroku-app-name: ${{ secrets.HEROKU_STAGING_APP_NAME }}
          heroku-email: ${{ secrets.HEROKU_EMAIL }}

      - name: Get commit info
        id: commit_info
        if: failure()
        run: |
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=%B | head -n 1)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT

      - name: Send Slack notification on failure
        if: failure()
        uses: ./.github/actions/slack-notify-frontend
        with:
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          status: failure
          environment: staging
          commit-sha: ${{ steps.commit_info.outputs.sha }}
          commit-message: ${{ steps.commit_info.outputs.message }}
          commit-author: ${{ steps.commit_info.outputs.author }}
