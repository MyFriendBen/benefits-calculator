name: Deploy to Production

on:
  release:
    types: [published]

jobs:
  deploy:
    name: Deploy Frontend to Heroku Production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://benefits-calculator-v1.herokuapp.com

    steps:
      - name: Checkout release tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: Deploy to Heroku
        uses: ./.github/actions/deploy-to-heroku
        with:
          heroku-api-key: ${{ secrets.HEROKU_API_KEY }}
          heroku-app-name: ${{ secrets.HEROKU_PROD_APP_NAME }}
          heroku-email: ${{ secrets.HEROKU_EMAIL }}

      - name: Get release info
        id: release_info
        run: |
          echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          echo "name=${{ github.event.release.name }}" >> $GITHUB_OUTPUT

      - name: Send deployment success notification to Slack
        if: success()
        uses: ./.github/actions/slack-notify-frontend
        with:
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          status: success
          environment: production
          release-tag: ${{ steps.release_info.outputs.tag }}
          release-name: ${{ steps.release_info.outputs.name }}
          release-url: ${{ github.event.release.html_url }}
          heroku-app-name: ${{ secrets.HEROKU_PROD_APP_NAME }}

      - name: Send deployment failure notification to Slack
        if: failure()
        uses: ./.github/actions/slack-notify-frontend
        with:
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          status: failure
          environment: production
          release-tag: ${{ github.event.release.tag_name }}
          release-url: ${{ github.event.release.html_url }}
